exports.changePassword = async (req, res) => {
  let connection;
  try {
    const { oldPassword, newPassword } = req.body;
    const id_pengguna = req.user.id_pengguna;

    // 1. Validasi Input Kosong
    if (!oldPassword || !newPassword) {
      return res.status(400).json({
        success: false,
        message: 'Password lama dan baru harus diisi'
      });
    }

    // 2. [UPGRADE] Validasi Panjang Password (Wajib sama kayak Frontend)
    if (newPassword.length < 6) {
      return res.status(400).json({
        success: false,
        message: 'Password baru minimal 6 karakter'
      });
    }

    connection = await getConnection();

    // Ambil password lama dari DB
    // Tips: Pakai alias "password" biar outputnya huruf kecil (konsisten)
    const userResult = await connection.execute(
      `SELECT password AS "password" FROM PENGGUNA WHERE id_pengguna = :id_pengguna`,
      [id_pengguna],
      { outFormat: oracledb.OUT_FORMAT_OBJECT }
    );

    if (userResult.rows.length === 0) {
      return res.status(404).json({ success: false, message: 'User tidak ditemukan' });
    }

    const currentHash = userResult.rows[0].password;

    // 3. Verifikasi Password Lama
    const isPasswordValid = await bcrypt.compare(oldPassword, currentHash);
    if (!isPasswordValid) {
      return res.status(401).json({
        success: false,
        message: 'Password lama salah'
      });
    }

    // 4. [UPGRADE] Cek apakah password baru SAMA dengan yang lama
    // (Opsional, tapi bagus buat security biar user beneran ganti)
    const isSamePassword = await bcrypt.compare(newPassword, currentHash);
    if (isSamePassword) {
      return res.status(400).json({
        success: false,
        message: 'Password baru tidak boleh sama dengan password lama'
      });
    }

    // 5. Hash Password Baru
    const hashedNewPassword = await bcrypt.hash(newPassword, 10);

    // 6. Update ke Database
    await connection.execute(
      `UPDATE PENGGUNA SET password = :password WHERE id_pengguna = :id_pengguna`,
      [hashedNewPassword, id_pengguna],
      { autoCommit: true }
    );

    res.status(200).json({
      success: true,
      message: 'Password berhasil diubah'
    });

  } catch (error) {
    console.error('Error change password:', error);
    res.status(500).json({
      success: false,
      message: 'Gagal mengubah password',
      error: error.message
    });
  } finally {
    if (connection) {
      try { await connection.close(); } catch (err) { console.error(err); }
    }
  }
};